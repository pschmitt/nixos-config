name: nix-update

on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  list-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.packages.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Collect package matrix
        id: packages
        run: |
          set -euo pipefail

          ./scripts/nix-update.sh --list > /tmp/packages.txt
          packages_json=$(jq -R . < /tmp/packages.txt | jq -cs 'map({"package": .})')
          echo "matrix={\"include\":${packages_json}}" >> "$GITHUB_OUTPUT"

  update:
    needs: list-packages
    if: needs.list-packages.outputs.matrix != ''
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-packages.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Update ${{ matrix.package }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
        run: |
          set -euo pipefail

          ./scripts/nix-update.sh --package "${{ matrix.package }}" --system x86_64-linux --system aarch64-linux

      - name: Create pull request for ${{ matrix.package }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
          branch: chore/nix-update/${{ matrix.package }}
          delete-branch: true
          commit-message: "chore: update ${{ matrix.package }}"
          title: "chore: update ${{ matrix.package }}"
          body: |
            Automated nix-update for `${{ matrix.package }}` on x86_64-linux and aarch64-linux.
            Generated by `.github/workflows/nix-update.yaml`.
