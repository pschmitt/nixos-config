name: nix-update

on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  list-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix-default: ${{ steps.packages.outputs.matrix-default }}
      matrix-oci: ${{ steps.packages.outputs.matrix-oci }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Collect package matrix
        id: packages
        run: |
          set -euo pipefail

          ./scripts/nix-update.sh --list > /tmp/packages.txt

          readarray -t PACKAGES < /tmp/packages.txt

          OCI_PACKAGES=("oracle-cloud-agent")
          DEFAULT_PACKAGES=()
          OCI_PACKAGES_FILTERED=()

          for pkg in "${PACKAGES[@]}"
          do
            if printf "%s\n" "${OCI_PACKAGES[@]}" | grep -Fxq "$pkg"
            then
              OCI_PACKAGES_FILTERED+=("$pkg")
            else
              DEFAULT_PACKAGES+=("$pkg")
            fi
          done

          MATRIX_DEFAULT=$(printf "%s\n" "${DEFAULT_PACKAGES[@]}" | jq -R . | jq -cs 'map({"package": .})')
          MATRIX_OCI=$(printf "%s\n" "${OCI_PACKAGES_FILTERED[@]}" | jq -R . | jq -cs 'map({"package": .})')

          if [[ "$(jq 'length' <<<"$MATRIX_DEFAULT")" != "0" ]]
          then
            echo "matrix-default={\"include\":${MATRIX_DEFAULT}}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "$(jq 'length' <<<"$MATRIX_OCI")" != "0" ]]
          then
            echo "matrix-oci={\"include\":${MATRIX_OCI}}" >> "$GITHUB_OUTPUT"
          fi

  update:
    needs: list-packages
    if: needs.list-packages.outputs.matrix-default != ''
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-packages.outputs.matrix-default) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Capture current version for ${{ matrix.package }}
        id: version_before
        run: |
          set -euo pipefail

          pkg="${{ matrix.package }}"
          old_version="$(nix eval --raw --impure ".#packages.x86_64-linux.${pkg}.version" 2>/dev/null || true)"

          echo "old_version=${old_version}" >>"$GITHUB_OUTPUT"

      - name: Update ${{ matrix.package }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
        run: |
          set -euo pipefail

          nix shell 'nixpkgs#nixfmt-rfc-style' -c ./scripts/nix-update.sh \
            --system x86_64-linux \
            --system aarch64-linux \
            "${{ matrix.package }}"

      - name: Compute PR title for ${{ matrix.package }}
        id: prmeta
        run: |
          set -euo pipefail

          pkg="${{ matrix.package }}"
          old_version="${{ steps.version_before.outputs.old_version }}"
          new_version="$(nix eval --raw --impure ".#packages.x86_64-linux.${pkg}.version" 2>/dev/null || true)"

          title="chore: update ${pkg}"

          if [[ -n "${old_version:-}" && -n "${new_version:-}" && "$old_version" != "$new_version" ]]
          then
            omaj=
            omin=
            nmaj=
            nmin=

            IFS='.' read -r omaj omin _rest <<<"$old_version" || true
            IFS='.' read -r nmaj nmin _rest <<<"$new_version" || true

            if [[ -n "${omaj:-}" && -n "${omin:-}" && -n "${nmaj:-}" && -n "${nmin:-}" ]]
            then
              old_series="${omaj}.${omin}.xx"
              new_series="${nmaj}.${nmin}.xx"
              title="chore: update ${pkg} from ${old_series} to ${new_series}"
            else
              title="chore: update ${pkg} from ${old_version} to ${new_version}"
            fi
          fi

          echo "title=${title}" >>"$GITHUB_OUTPUT"
          echo "commit_message=${title}" >>"$GITHUB_OUTPUT"

      - name: Create pull request for ${{ matrix.package }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
          branch: chore/nix-update/${{ matrix.package }}
          delete-branch: true
          commit-message: "${{ steps.prmeta.outputs.commit_message }}"
          title: "${{ steps.prmeta.outputs.title }}"
          body: |
            Automated nix-update for `${{ matrix.package }}` on x86_64-linux and aarch64-linux.
            Generated by `.github/workflows/nix-update.yaml`.

  update-oci:
    needs: list-packages
    if: needs.list-packages.outputs.matrix-oci != ''
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-packages.outputs.matrix-oci) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Capture current version for ${{ matrix.package }}
        id: version_before
        run: |
          set -euo pipefail

          pkg="${{ matrix.package }}"
          old_version="$(nix eval --raw --impure ".#packages.x86_64-linux.${pkg}.version" 2>/dev/null || true)"

          echo "old_version=${old_version}" >>"$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Netbird Connect
        id: netbird
        uses: Alemiz112/netbird-connect@v1
        with:
          setup-key: ${{ secrets.NB_SETUP_KEY }}

      - name: Wait for Netbird routes
        env:
          NB_INTERFACE: wt0
          YUM_DOMAIN: yum.eu-frankfurt-1.oci.oraclecloud.com
          WAIT_SECS: "180"
          SLEEP_SECS: "3"
        run: |
          set -euo pipefail
          DEADLINE=$((SECONDS + WAIT_SECS))

          echo "Waiting for $YUM_DOMAIN to route via $NB_INTERFACE"

          while (( SECONDS < DEADLINE ))
          do
            if ! mapfile -t ips < <(dig +short A "$YUM_DOMAIN" | grep -v '^$')
            then
              echo "dig failed, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            if (( ${#ips[@]} == 0 ))
            then
              echo "No IPs resolved yet, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            READY=1
            for ip in "${ips[@]}"
            do
              if ! route_json=$(ip -j route get "$ip" 2>/dev/null)
              then
                READY=
                break
              fi

              if ! jq -e --arg iface "$NB_INTERFACE" '
                .[0].dev == $iface
              ' <<<"$route_json" >/dev/null
              then
                READY=
                break
              fi
            done

            if [[ -n "${READY:-}" ]]
            then
              echo "All $YUM_DOMAIN routes go via $NB_INTERFACE"
              exit 0
            fi

            sleep "$SLEEP_SECS"
          done

          echo "Timed out waiting for $YUM_DOMAIN routes via $NB_INTERFACE" >&2
          ip r
          exit 1

      - name: Update ${{ matrix.package }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
        run: |
          set -euo pipefail

          nix shell 'nixpkgs#nixfmt-rfc-style' -c ./scripts/nix-update.sh \
            --system x86_64-linux \
            --system aarch64-linux \
            "${{ matrix.package }}"

      - name: Compute PR title for ${{ matrix.package }}
        id: prmeta
        run: |
          set -euo pipefail

          pkg="${{ matrix.package }}"
          old_version="${{ steps.version_before.outputs.old_version }}"
          new_version="$(nix eval --raw --impure ".#packages.x86_64-linux.${pkg}.version" 2>/dev/null || true)"

          title="chore: update ${pkg}"

          if [[ -n "${old_version:-}" && -n "${new_version:-}" && "$old_version" != "$new_version" ]]
          then
            omaj=
            omin=
            nmaj=
            nmin=

            IFS='.' read -r omaj omin _rest <<<"$old_version" || true
            IFS='.' read -r nmaj nmin _rest <<<"$new_version" || true

            if [[ -n "${omaj:-}" && -n "${omin:-}" && -n "${nmaj:-}" && -n "${nmin:-}" ]]
            then
              old_series="${omaj}.${omin}.xx"
              new_series="${nmaj}.${nmin}.xx"
              title="chore: update ${pkg} from ${old_series} to ${new_series}"
            else
              title="chore: update ${pkg} from ${old_version} to ${new_version}"
            fi
          fi

          echo "title=${title}" >>"$GITHUB_OUTPUT"
          echo "commit_message=${title}" >>"$GITHUB_OUTPUT"

      - uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: List GPG keys
        run: gpg -K

      - name: Create pull request for ${{ matrix.package }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
          branch: nix-update/${{ matrix.package }}
          delete-branch: true
          commit-message: "${{ steps.prmeta.outputs.commit_message }}"
          title: "${{ steps.prmeta.outputs.title }}"
          body: |
            Automated nix-update for `${{ matrix.package }}` on x86_64-linux and aarch64-linux.
            Generated by `.github/workflows/nix-update.yaml`.
