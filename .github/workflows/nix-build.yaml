name: Nix build

on:
  push:
  workflow_dispatch: # allows manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # https://nix.dev/manual/nix/2.18/advanced-topics/distributed-builds
  NIX_BUILDER: "ssh://${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} aarch64-linux,i686-linux,x86_64-linux /home/runner/.ssh/id_ed25519 - - - - -"
  NIX_DEST_STORE_URL: "ssh-ng://${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}?ssh-key=/home/runner/.ssh/id_ed25519"
  nix-conf: |-
    fallback = true # build from source if a binary substitute fails
    extra-experimental-features = nix-command flakes
    accept-flake-config = true
    substituters = https://cache.nixos.org/ https://hyprland.cachix.org https://hyprland.cachix.org https://nix-community.cachix.org ssh-ng://${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}?ssh-key=/home/runner/.ssh/id_ed25519&trusted=true
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= hyprland.cachix.org-1:a7pgxzMz7+chwVL3/pzj6jIBMioiJM7ypFP8PwtkuGc= nix-cache.brkn.lol:k/zdgSv+6lcJ/9DRILjA7H18eIlFSA0OwzyqqXEwySM= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= rofl-10:vYRBSypcO/0NnPsDxgSELIcJotU/LmZ1f6vZUKUmty0= rofl-13:ESRCqy2jcftg690k98KSNqF6LgOqz1X7ZnXXE//WWD0=
    extra-platforms = aarch64-linux i686-linux
    builders-use-substitutes = true
    access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      # magic cache is back!
      # https://determinate.systems/posts/bringing-back-magic-nix-cache-action/
      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Generate build matrix
        id: set-matrix
        shell: bash
        run: |
          echo "matrix=$(./.github/workflows/scripts/nix-gh-build-matrix.sh)" \
            >> $GITHUB_OUTPUT

  build-pkgs-free:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.setup-matrix.outputs.matrix).pkgs.free }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Store SSH key on disk
        run: |-
          mkdir -p "${HOME}/.ssh"
          KEY_PATH="${HOME}/.ssh/id_ed25519"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 400 "$KEY_PATH"

      - name: Setup known_hosts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 1
          max_attempts: 3
          shell: bash
          command: |
            set -o pipefail
            ssh-keyscan "${{ secrets.SSH_HOST }}" | \
              sudo tee -a "${HOME}/.ssh/known_hosts" /etc/ssh/ssh_known_hosts

      - name: Build package
        run: |-
          nix build --print-build-logs \
            '.#packages.x86_64-linux.${{ matrix.pkg }}'

      - name: "Nix copy package"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            # DEBUG
            ssh-keyscan "${{ secrets.SSH_HOST }}"
            echo "Known hosts:"
            cat /etc/ssh/ssh_known_hosts

            umask 077
            printf '%s' "${{ secrets.NIX_STORE_PRIVKEY }}" > /tmp/nix-store-privkey.pem
            nix copy --to "$NIX_DEST_STORE_URL" --sign --key-file /tmp/nix-store-privkey.pem \
              '.#packages.x86_64-linux.${{ matrix.pkg }}'

  build-pkgs-oci:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.setup-matrix.outputs.matrix).pkgs.oci }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Store SSH key on disk
        run: |-
          mkdir -p "${HOME}/.ssh"
          KEY_PATH="${HOME}/.ssh/id_ed25519"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 400 "$KEY_PATH"

      - name: Setup known_hosts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 1
          max_attempts: 3
          shell: bash
          command: |
            set -o pipefail
            ssh-keyscan "${{ secrets.SSH_HOST }}" | \
              sudo tee -a "${HOME}/.ssh/known_hosts" /etc/ssh/ssh_known_hosts

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Netbird Connect
        id: netbird
        uses: Alemiz112/netbird-connect@v1
        with:
          setup-key: ${{ secrets.NB_SETUP_KEY }}

      - name: Wait for Netbird routes
        env:
          NB_INTERFACE: wt0
          YUM_DOMAIN: yum.eu-frankfurt-1.oci.oraclecloud.com
          WAIT_SECS: "180"
          SLEEP_SECS: "3"
        run: |
          set -euo pipefail
          deadline=$((SECONDS + WAIT_SECS))

          echo "Waiting for $YUM_DOMAIN to route via $NB_INTERFACE"

          while (( SECONDS < deadline ))
          do
            if ! mapfile -t ips < <(dig +short A "$YUM_DOMAIN" | grep -v '^$')
            then
              echo "dig failed, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            if (( ${#ips[@]} == 0 ))
            then
              echo "No IPs resolved yet, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            READY=true
            for ip in "${ips[@]}"
            do
              if ! route_json=$(ip -j route get "$ip" 2>/dev/null)
              then
                READY=false
                break
              fi

              if ! jq -e --arg iface "$NB_INTERFACE" '
                .[0].dev == $iface
              ' <<<"$route_json" >/dev/null
              then
                READY=false
                break
              fi
            done

            if [[ "$READY" == true ]]
            then
              echo "All $YUM_DOMAIN routes go via $NB_INTERFACE"
              exit 0
            fi

            sleep "$SLEEP_SECS"
          done

          echo "Timed out waiting for $YUM_DOMAIN routes via $NB_INTERFACE" >&2
          ip r
          exit 1

      - name: Build package (aarch64-linux)
        run: |-
          nix build --print-build-logs --builders "$NIX_BUILDER" \
            '.#packages.aarch64-linux.${{ matrix.pkg }}'
          tree result

      - name: Build package (x86_64-linux)
        run: |-
          nix build --print-build-logs --builders "$NIX_BUILDER" \
            '.#packages.x86_64-linux.${{ matrix.pkg }}'
          tree result

      - name: "Nix copy packages"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            # DEBUG
            ssh-keyscan "${{ secrets.SSH_HOST }}"
            echo "Known hosts:"
            cat /etc/ssh/ssh_known_hosts

            umask 077
            printf '%s' "${{ secrets.NIX_STORE_PRIVKEY }}" > /tmp/nix-store-privkey.pem
            nix copy --to "$NIX_DEST_STORE_URL" --sign --key-file /tmp/nix-store-privkey.pem \
              '.#packages.aarch64-linux.${{ matrix.pkg }}' \
              '.#packages.x86_64-linux.${{ matrix.pkg }}'

  build-pkgs-nonfree:
    needs: setup-matrix
    runs-on: ubuntu-latest
    env:
      NIXPKGS_ALLOW_UNFREE: 1
      SSH_PRIVATE_KEY_PATH: "/home/runner/.ssh/id_ed25519"
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.setup-matrix.outputs.matrix).pkgs.nonfree }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      # NOTE You might want to disable magic-nix-cache-action since it will
      # technically redistribute our proprietary packages (by putting them in
      # the GitHub Actions cache). Luckily this should is not available outside
      # of GH Actions run from within this repo.
      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Store SSH key on disk
        run: |-
          mkdir -p "${HOME}/.ssh"
          KEY_PATH="${HOME}/.ssh/id_ed25519"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 400 "$KEY_PATH"

      - name: Setup known_hosts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 1
          max_attempts: 3
          shell: bash
          command: |
            set -o pipefail
            ssh-keyscan "${{ secrets.SSH_HOST }}" | \
              sudo tee -a "${HOME}/.ssh/known_hosts" /etc/ssh/ssh_known_hosts

      - name: Fetch proprietary garbage
        uses: nick-fields/retry@v3
        env:
          BLOBS_BASIC_AUTH: ${{ secrets.BLOBS_BASIC_AUTH }}
        with:
          timeout_minutes: 5
          max_attempts: 3
          shell: bash
          command: |-
            ./scripts/fetch-proprietary-garbage.sh

      - name: Trick flake by git adding all files (ignoring .gitignore)
        run: |-
          git add --intent-to-add --force .

      - name: Build package
        # NOTE --impure is required for consuming env vars (ie. NIXPKGS_ALLOW_UNFREE)
        run: |-
          nix build --print-build-logs --builders "$NIX_BUILDER" --impure \
            '.#packages.x86_64-linux.${{ matrix.pkg }}'
          tree result

      - name: "Nix copy package"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            # DEBUG
            ssh-keyscan "${{ secrets.SSH_HOST }}"
            echo "Known hosts:"
            cat /etc/ssh/ssh_known_hosts

            umask 077
            printf '%s' "${{ secrets.NIX_STORE_PRIVKEY }}" > /tmp/nix-store-privkey.pem
            nix copy --to "$NIX_DEST_STORE_URL" --sign --key-file /tmp/nix-store-privkey.pem --impure \
              '.#packages.x86_64-linux.${{ matrix.pkg }}'

  build-hosts-x86_64:
    needs:
      - setup-matrix
      - build-pkgs-free
      - build-pkgs-nonfree
    if: ${{ always() && (needs.setup-matrix.result == 'success') }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.setup-matrix.outputs.matrix).hosts.amd64 }}
    steps:
      # - name: Free Disk Space (Ubuntu)
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: true

      - uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Store SSH key on disk
        run: |-
          mkdir -p "${HOME}/.ssh"
          KEY_PATH="${HOME}/.ssh/id_ed25519"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 400 "$KEY_PATH"

      - name: Setup known_hosts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 1
          max_attempts: 3
          shell: bash
          command: |
            set -o pipefail
            ssh-keyscan "${{ secrets.SSH_HOST }}" | \
              sudo tee -a "${HOME}/.ssh/known_hosts" /etc/ssh/ssh_known_hosts

      - name: Fetch proprietary garbage
        uses: nick-fields/retry@v3
        env:
          BLOBS_BASIC_AUTH: ${{ secrets.BLOBS_BASIC_AUTH }}
        with:
          timeout_minutes: 5
          max_attempts: 3
          shell: bash
          command: |-
            ./scripts/fetch-proprietary-garbage.sh

      - name: Add proprietary garbage to Nix store
        run: |
          find . -name sha256sum.txt | while read checksum_file; do
            dir=$(dirname "$checksum_file")
            awk '{print $2}' "$checksum_file" | while read filename; do
              if [ -f "$dir/$filename" ]; then
                echo "Adding $dir/$filename to Nix store..."
                nix-store --add-fixed sha256 "$dir/$filename"
              fi
            done
          done

      - name: Build nixosConfiguration
        run: |-
          nix build --print-build-logs \
            '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'

      - name: "Nix copy package"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            # DEBUG
            ssh-keyscan "${{ secrets.SSH_HOST }}"
            echo "Known hosts:"
            cat /etc/ssh/ssh_known_hosts

            umask 077
            printf '%s' "${{ secrets.NIX_STORE_PRIVKEY }}" > /tmp/nix-store-privkey.pem
            nix copy --to "$NIX_DEST_STORE_URL" --sign --key-file /tmp/nix-store-privkey.pem \
              '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'

  build-hosts-aarch64:
    needs:
      - setup-matrix
      - build-pkgs-free
      - build-pkgs-nonfree
      - build-pkgs-oci
    if: ${{ always() && (needs.setup-matrix.result == 'success') }}
    runs-on: ubuntu-latest
    # runs-on: ubuntu-24.04-arm
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.setup-matrix.outputs.matrix).hosts.aarch64 }}
    steps:
      # - name: Free Disk Space (Ubuntu)
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: true

      - uses: wimpysworld/nothing-but-nix@main
        with:
          # 'cleave' removes docker, which we need later for qemu
          hatchet-protocol: 'carve'

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      # - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Store SSH key on disk
        run: |-
          mkdir -p "${HOME}/.ssh"
          KEY_PATH="${HOME}/.ssh/id_ed25519"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 400 "$KEY_PATH"

      - name: Setup known_hosts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 1
          max_attempts: 3
          shell: bash
          command: |
            set -o pipefail
            ssh-keyscan "${{ secrets.SSH_HOST }}" | \
              sudo tee -a "${HOME}/.ssh/known_hosts" /etc/ssh/ssh_known_hosts

      - name: Fetch proprietary garbage
        uses: nick-fields/retry@v3
        env:
          BLOBS_BASIC_AUTH: ${{ secrets.BLOBS_BASIC_AUTH }}
        with:
          timeout_minutes: 5
          max_attempts: 3
          shell: bash
          command: |-
            ./scripts/fetch-proprietary-garbage.sh

      - name: Add proprietary garbage to Nix store
        run: |
          find . -name sha256sum.txt | while read checksum_file; do
            dir=$(dirname "$checksum_file")
            awk '{print $2}' "$checksum_file" | while read filename; do
              if [ -f "$dir/$filename" ]; then
                echo "Adding $dir/$filename to Nix store..."
                nix-store --add-fixed sha256 "$dir/$filename"
              fi
            done
          done

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Netbird Connect
        id: netbird
        uses: Alemiz112/netbird-connect@v1
        with:
          # management-url: https://api.netbird.io:443
          setup-key: ${{ secrets.NB_SETUP_KEY }}

      - name: Wait for Netbird routes
        env:
          NB_INTERFACE: wt0
          YUM_DOMAIN: yum.eu-frankfurt-1.oci.oraclecloud.com
          WAIT_SECS: "180"
          SLEEP_SECS: "3"
        run: |
          set -euo pipefail
          deadline=$((SECONDS + WAIT_SECS))

          echo "Waiting for $YUM_DOMAIN to route via $NB_INTERFACE"

          while (( SECONDS < deadline ))
          do
            if ! mapfile -t ips < <(dig +short A "$YUM_DOMAIN" | grep -v '^$')
            then
              echo "dig failed, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            if (( ${#ips[@]} == 0 ))
            then
              echo "No IPs resolved yet, retrying..."
              sleep "$SLEEP_SECS"
              continue
            fi

            READY=true
            for ip in "${ips[@]}"
            do
              if ! route_json=$(ip -j route get "$ip" 2>/dev/null)
              then
                READY=false
                break
              fi

              if ! jq -e --arg iface "$NB_INTERFACE" '
                .[0].dev == $iface
              ' <<<"$route_json" >/dev/null
              then
                READY=false
                break
              fi
            done

            if [[ "$READY" == true ]]
            then
              echo "All $YUM_DOMAIN routes go via $NB_INTERFACE"
              exit 0
            fi

            sleep "$SLEEP_SECS"
          done

          echo "Timed out waiting for $YUM_DOMAIN routes via $NB_INTERFACE" >&2
          ip r
          exit 1

      - name: Build nixosConfiguration
        run: |-
          nix build --print-build-logs --builders "$NIX_BUILDER" \
            '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'

      - name: "Nix copy package"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            # DEBUG
            ssh-keyscan "${{ secrets.SSH_HOST }}"
            echo "Known hosts:"
            cat /etc/ssh/ssh_known_hosts

            umask 077
            printf '%s' "${{ secrets.NIX_STORE_PRIVKEY }}" > /tmp/nix-store-privkey.pem
            nix copy --to "$NIX_DEST_STORE_URL" --sign --key-file /tmp/nix-store-privkey.pem \
              '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'
