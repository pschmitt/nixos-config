name: Nix build

on:
  push:
  workflow_dispatch: # allows manual triggering

env:
  nix-conf: |-
    substituters = https://cache.garnix.io https://cache.nixos.org/ https://hyprland.cachix.org https://hyprland.cachix.org https://nix-cache.heimat.dev https://nix-community.cachix.org
    trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= hyprland.cachix.org-1:a7pgxzMz7+chwVL3/pzj6jIBMioiJM7ypFP8PwtkuGc= nix-cache.heimat.dev:k/zdgSv+6lcJ/9DRILjA7H18eIlFSA0OwzyqqXEwySM= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Generate build matrix
        id: set-matrix
        shell: bash
        run: |
          echo "matrix=$(./.github/workflows/scripts/nix-flake-show.sh)" \
            >> $GITHUB_OUTPUT

  build-pkgs-free:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.setup-matrix.outputs.matrix).pkgs.free }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build package
        run: |-
          nix build --print-build-logs \
            '.#packages.x86_64-linux.${{ matrix.pkg }}'

  build-pkgs-nonfree:
    needs: setup-matrix
    runs-on: ubuntu-latest
    env:
      NIX_BUILDER: "ssh://${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}?ssh-key=${{ env.HOME }}/.ssh/id_ed25519"
      SSH_PRIVATE_KEY_PATH: "${{ env.HOME }}/.ssh/id_ed25519"
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.setup-matrix.outputs.matrix).pkgs.nonfree }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup SSH
        run: |-
          SSH_PRIVATE_KEY="${HOME}/.ssh/id_ed25519"
          printf '%s' "${{ secrets.SSH_PRIVATE_KEY }}" > "$SSH_PRIVATE_KEY_PATH"
          chmod 400 "$SSH_PRIVATE_KEY_PATH"
          ssh-keyscan "${{ secrets.SSH_HOST }}" >> "${HOME}/.ssh/known_hosts"
          eval "$(ssh-agent)"
          ssh-add "$SSH_PRIVATE_KEY_PATH"

      - name: Fetch sources
        run: |-
          ./pkgs/fonts/src/fetch-fonts.sh

      - name: Build package
        run: |-
          nix build --print-build-logs --builders "$NIX_BUILDER" \
            '.#packages.x86_64-linux.${{ matrix.pkg }}'

  build-hosts:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.setup-matrix.outputs.matrix).hosts }}
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: ${{ env.nix-conf }}

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build nixosConfiguration
        run: |-
           nix build --print-build-logs \
             '.#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel'
